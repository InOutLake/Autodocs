```markdown
# Объект макета (Layout). Сценарии
Обновлено 6 августа 2025, 15:49
Бакыт Ниязалиев

## Глоссарий

| Термин | Описание |
| --- | --- |
| 1 | **Инфографика** Wikipedia. Графический способ подачи информации и данных, целью которого является ясная визуализация сложной информации |
| 2 | **S3** Объектное хранилище. [Wikipedia](https://en.wikipedia.org/wiki/Amazon_S3  ) |

### Атрибуты

| № | Атрибут | Тип | Описание |
| --- | --- | --- | --- |
| 1 | `id` | ObjectID ([MongoDB ObjectID](https://www.mongodb.com/docs/manual/reference/bson-types/#objectid)) | Идентификатор |
| 2 | `thumbnail_key` | String | Ключ объекта в S3. Заранее отрисованное изображение макета |
| 3 | `background_key` | String или NULL | Ключ объекта в S3. Изображение фона в макете |
| 4 | `content` | Object<String, Any> | JSON Объект ключ-значение, где значение может быть любого типа определенного в [JSON типах данных](  https://en.wikipedia.org/wiki/JSON  ) |
| 5 | `created_at` | DateTime | Дата и время создания |
| 6 | `updated_at` | DateTime | Дата и время обновления |
| 7 | `featured_at` | DateTime или NULL | Дата и время [выдвижения](#4-выдвижение-макета) |
| 8 | `owner_id` | String | Идентификатор пользователя, владельца макета. |
| 9 | `aspect_ratio` | String | Соотношение сторон макета в формате `"a:b"`, где `a` и `b` - положительные целые числа |
| 10 | `scope` | ScopeTypes (`user` или `global`) | Определяет область видимости макета |
| 11 | `is_free` | Boolean | Бесплатный ли макет |
| 12 | `meta` | Object<String, Any> | Метаданные макета |
| 13 | `meta.source_id` | ObjectID | ID оригинального макета-родителя копии |

## Сценарии

### Авторизация

Доступны пользователям только с ролью `regular`

### Объект макета в HTTP-ответах.

Ниже пример объекта макета в JSON-формате, отправляемого по-умолчанию. Если в эндпоинтах не приведен пример ответа или не описан, то принимать следующий пример ответа, как ответ этого эндпоинта.

```json
{
  "id": "string",
  "owner_id": "string",
  "scope": "user",
  "is_free": true,
  "thumbnail_url": "https://example.com/image.webp  ", // HTTP ссылка на файл миниатюры, действует 1 час
  "background_url": "https://example.com/image.png  ", // HTTP ссылка на файл фона
  "content": {...},
  "aspect_ratio": "1:2",
  "featured_at": "2025-07-04T15:46:20.120454",
  "created_at": "2025-07-04T15:46:20.120454",
  "updated_at": "2025-07-04T15:46:20.120454",
  "meta": {
    "source_id": "string"
  }
}
```

### Общие ошибки

*   `layout_not_found` - 404 - Макет не найден
*   `layout_access_denied` - 403 - Доступ запрещен

---

### 1. Получение макетов

**URL:** `GET /layouts`

**Описание:**
Получение списка макетов с пагинацией. Макеты сортируются по `featured_at` в порядке убывания, затем по `created_at` в порядке убывания.

**Параметры запроса:**

*   `aspect_ratio` - фильтр по атрибуту `aspect_ratio` макета
*   `scope` - фильтр по атрибуту `scope` макета

**Ответ:**

```json
{
  "items": [
    {
      "id": "string",
      "owner_id": "string",
      "scope": "user",
      "is_free": true,
      "thumbnail_url": "https://example.com/image.webp  ", // HTTP ссылка на файл миниатюры, действует 1 час
      "background_url": "https://example.com/image.png  ", // HTTP ссылка на файл фона
      "content": {...},
      "aspect_ratio": "1:2",
      "featured_at": "2025-07-04T15:46:20.120454",
      "created_at": "2025-07-04T15:46:20.120454",
      "updated_at": "2025-07-04T15:46:20.120454",
      "meta": {
        "source_id": "string"
      }
    }
  ],
  "total": "integer",
  "page": "integer",
  "size": "integer"
}
```

**Ошибки:**

```json
{
  "error_code": "layout_not_found",
  "detail": null
}
```

```json
{
  "error_code": "layout_access_denied",
  "detail": null
}
```

---

### 2. Создание макета

**URL:** `POST /layouts`

**Описание:**
Создание нового макета.

**Логика:**

1.  Сохраняет миниатюру и фон (если передан) в S3 под ключами:
    *   `<ОКРУЖЕНИЕ>/<ИДЕНТИФИКАТОР ПОЛЬЗОВАТЕЛЯ>/layouts/<ИДЕНТИФИКАТОР МАКЕТА>/thumbnail.webp`
    *   `<ОКРУЖЕНИЕ>/<ИДЕНТИФИКАТОР ПОЛЬЗОВАТЕЛЯ>/layouts/<ИДЕНТИФИКАТОР МАКЕТА>/background.<РАСШИРЕНИЕ ФАЙЛА ФОНА>`
2.  Миниатюра сжимается в 5 раз и сохраняется в формате WebP. Фон сохраняется в исходном формате.
3.  Создает макет в базе данных.

**Тело запроса:**

```json
{
  "thumbnail_key": "bQ8/JU5ZqK/B2PZZcNDpSARe8fQNq0hTADQN4M+xrSiKlvnsV8ZuTRZWpW8u6sKNomsUgChdOlp6Zg3iPUt3zPiCKZvEhcSp",
  "background_key": "EN/VeVOp9ueQWWV+stAD4B5N1VWiG1gyC1yufqWPZMn5AN/g9R+Kqb8=", // Необязательный, по-умолчанию null
  "content": {...}, // Ключи должны соответствовать регулярному выражению ^[^.$\x00][^.\x00]*$
  "aspect_ratio": "1:2" // Длина от 5 до 32 символов, соответствует ^[1-9]\d*:[1-9]\d*$
}
```

**Ответ:**

Код `201` - Успех. Возвращает созданный макет.

---

### 3. Удаление макета

**URL:** `DELETE /layouts/{layout_id}`

**Описание:**
Удаление макета по его ID.

**Параметры пути:**

*   `layout_id` (string, обязательный) ID макета для удаления.

**Ответ:**

Успех `204`. Макет удален. Ничего не возвращает в теле ответа.

---

### 4. Выдвижение макета

**URL:** `POST /layouts/{layout_id}/feature`

**Описание:**
Выдвижение макета по его ID. При выдвижении глобального макета, создается его копия с заполненными полями `owner_id`, `featured_at` и `meta.source_id`, возвращается копия глобального макета.

**Параметры пути:**

*   `layout_id` (string, обязательный) ID макета для выдвижения.

**Ответ:**

Возвращает копию макета с заполненным полем `featured_at` в формате нынешних даты и времени.

**Ошибки:**

```json
{
  "error_code": "layout_already_featured",
  "detail": null
}
```

---

### 5. Отмена выдвижения макета

**URL:** `POST /layouts/{layout_id}/unfeature`

**Описание:**
Отмена выдвижения макета по его ID. При отмене выдвижения глобального макета, надо отправлять идентификатор копии, который был создан при выдвижении макета пользователя. Копия будет удаляться, а вернется оригинал макета.

**Параметры пути:**

*   `layout_id` (string, обязательный) ID макета для отмены выдвижения.

**Ответ:**

Возвращает оригинальный макет с `featured_at` равным Null.

**Ошибки:**

```json
{
  "error_code": "layout_already_unfeatured",
  "detail": null
}
```

---

## Административные роуты

### 1. Получение макетов

**URL:** `GET /admin/layouts/`

**Описание:**
Получение страницы макетов в соответствии с фильтрами. Фильтры, как и параметры страницы, передаются как Query параметры. Все параметры необязательны.

**Доступные фильтры:**

*   `scope` (string) - область видимости макета
*   `owner_id` (string) - ID пользователя
*   `aspect_ratio` (string) - отношение сторон макета
*   `featured` (boolean) - является ли макет выдвинутым

**Ответ:**

```json
{
  "items": [
    {
      "id": "string",
      "owner_id": "string",
      "scope": "user",
      "is_free": true,
      "thumbnail_url": "https://example.com/image.webp  ", // HTTP ссылка на файл миниатюры, действует 1 час
      "background_url": "https://example.com/image.png  ", // HTTP ссылка на файл фона
      "content": {...},
      "aspect_ratio": "1:2",
      "featured_at": "2025-07-04T15:46:20.120454",
      "created_at": "2025-07-04T15:46:20.120454",
      "updated_at": "2025-07-04T15:46:20.120454",
      "meta": {
        "source_id": "string"
      }
    }
  ],
  "total": "integer",
  "page": "integer",
  "size": "integer"
}
```

---

### 2. Обновление макетов

**URL:** `PATCH /admin/layouts/{layout_id}`

**Описание:**
Изменение данных макета.

**Параметры пути:**

*   `layout_id` (string, обязательный) - ID макета для изменения

**Модель изменения:**

Все поля модели необязательные.

```json
{
  "owner_id": "string",
  "scope": "user", // или "global"
  "aspect_ratio": "1:2",
  "featured_at": "2025-07-04T15:46:20.120454"
}
```

**Ответ:**

*   `201` - Успех, возвращает измененный макет
*   `400` - Неверные входные данные или ошибка валидации

---

### 3. Глобальная копия макета

**URL:** `POST /admin/layouts/{layout_id}/copy_as_global`

**Описание:**
Создаёт копию пользовательского макета и делает её глобальной (`global`)

**Параметры пути:**

*   `layout_id` (string, обязательный) - ID макета для копирования

**Ответ:**

*   `201` - Успех, возвращает измененный макет

---

## История документа

| № | Автор | Комментарий | Дата и время UTC+7 |
| --- | --- | --- | --- |
| 1 | @nobody | Написал базовую документацию |  |
| 2 | @nobody | Добавил возможные ошибки в сценариях |  |
| 3 | @nobody | Добавил атрибут `aspect_ratio` к макетам. Влияет на сценарии: [Получения](#1-получение-макетов) - добавлен фильтр по `aspect_ratio` в параметрах запроса; [Создания](#2-создание-макета) - добавлено обязательное поле `aspect_ratio` в теле запроса и описана его валидация. Также в ответах эндпоинтов [Макет в ответах](#объект-макета-в-http-ответах) - добавлено поле `aspect_ratio` в ответах. В таблице атрибутов обозначено что это за поле и зачем нужно. | 09.07.2025 13:11 |
| 4 | @nobody | Атрибут `background` у макетов теперь опционален. Влияет на сценарии: [Создания](#2-создание-макета) - поле `background` теперь опциональное. Также в ответах эндпоинтов [Макет в ответах](#объект-макета-в-http-ответах) | 10.07.2025 12:55 |
| 5 | @somebody | Добавлена информация о административных роутах. В модель Layout добавлены поля `scope`, `is_free` и `meta`. В соостветствии с изменениями обновлена докуентация существующих роутов. | 06.08.25 14:08 |
| 6 | @somebody | Изменены пользовательские роуты. Добавлен фильтр по `scope`. Изменена логика выдвижения макетов. | 06.08.25 14:47 |
```
```
